{% extends "base.html" %}
{% block title %}รายละเอียดกิจกรรม - DSNPRU_REG{% endblock %}
{% block head_extra %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('activityDetailPage', () => ({
            activityId: "{{ activity_id }}",
            registrations: [],
            async load() {
                const token = sessionStorage.getItem('adminToken');
                if (!token) { window.location.href = '/admin/login'; return; }
                const res = await axios.get(`/admin/registrations/${this.activityId}`, {
                    headers: { Authorization: 'Bearer ' + token }
                });
                this.registrations = res.data;
                this.$nextTick(() => {
                    if ($('#regTable').length) {
                        $('#regTable').DataTable();
                    }
                });
            },
            async exportExcel() {
                const token = sessionStorage.getItem('adminToken');
                const url = `/export/excel?activity_id=${this.activityId}`;
                const res = await axios.get(url, {
                    headers: { Authorization: 'Bearer ' + token },
                    responseType: 'blob'
                });
                saveAs(res.data, 'registrations.xlsx');
            },
            async exportPdf() {
                const token = sessionStorage.getItem('adminToken');
                const url = `/export/pdf?activity_id=${this.activityId}`;
                const res = await axios.get(url, {
                    headers: { Authorization: 'Bearer ' + token },
                    responseType: 'blob'
                });
                const blobUrl = URL.createObjectURL(res.data);
                window.open(blobUrl, '_blank');
            },
            async deleteRegistration(id) {
                const { isConfirmed } = await Swal.fire({
                    title: 'ยืนยันการลบ?',
                    text: "คุณต้องการนำนักเรียนคนนี้ออกจากกิจกรรมใช่หรือไม่?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#e11d48',
                    confirmButtonText: 'ยืนยัน',
                    cancelButtonText: 'ยกเลิก'
                });
                if (!isConfirmed) return;

                const token = sessionStorage.getItem('adminToken');
                try {
                    await axios.delete(`/admin/registrations/${id}`, {
                        headers: { Authorization: 'Bearer ' + token }
                    });
                    this.load();
                    Swal.fire('สำเร็จ', 'ลบการลงทะเบียนเรียบร้อยแล้ว', 'success');
                } catch (e) {
                    Swal.fire('ผิดพลาด', e.response?.data?.detail || 'ไม่สามารถลบได้', 'error');
                }
            }
        }));
    });
</script>
{% endblock %}
{% block content %}
<section x-data="activityDetailPage()" x-init="load()">
    <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-semibold">รายชื่อผู้สมัครกิจกรรม</h1>
        <a href="/admin/activities" class="text-xs text-rose-600 hover:underline">กลับหน้าจัดการกิจกรรม</a>
    </div>

    <div class="flex justify-end gap-2 mb-3 text-xs">
        <button class="px-3 py-1.5 rounded-full border border-slate-300 dark:border-slate-600" @click="exportExcel">
            ส่งออก Excel
        </button>
        <button class="px-3 py-1.5 rounded-full bg-slate-900 text-white" @click="exportPdf">
            ส่งออก PDF
        </button>
    </div>

    <div
        class="rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-4 overflow-x-auto">
        <table id="regTable" class="display text-xs w-full">
            <thead>
                <tr>
                    <th>ชื่อ–สกุล</th>
                    <th>ห้อง</th>
                    <th>เลขที่</th>
                    <th>เวลา</th>
                    <th class="text-right">จัดการ</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="r in registrations" :key="r.id">
                    <tr>
                        <td x-text="r.student.name"></td>
                        <td x-text="r.student.classroom"></td>
                        <td x-text="r.student.number"></td>
                        <td x-text="new Date(r.timestamp).toLocaleString('th-TH')"></td>
                        <td class="text-right">
                            <button @click="deleteRegistration(r.id)"
                                class="text-rose-600 hover:text-rose-800 transition p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>
</section>
{% endblock %}