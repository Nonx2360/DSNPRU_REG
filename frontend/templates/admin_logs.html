{% extends "base.html" %}
{% block title %}System Logs - DSNPRU_REG{% endblock %}
{% block head_extra %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('logsPage', () => ({
            logs: [],
            search: '',
            async load() {
                const token = sessionStorage.getItem('adminToken');
                if (!token) { window.location.href = '/admin/login'; return; }
                try {
                    const res = await axios.get('/admin/api/logs', {
                        headers: { Authorization: 'Bearer ' + token }
                    });
                    this.logs = res.data;
                } catch (e) {
                    console.error(e);
                    if (e.response && e.response.status === 401) {
                        window.location.href = '/admin/login';
                    }
                }
            },
            get filteredLogs() {
                if (!this.search) return this.logs;
                const q = this.search.toLowerCase();
                return this.logs.filter(l =>
                    l.admin_username.toLowerCase().includes(q) ||
                    l.action.toLowerCase().includes(q) ||
                    (l.details && l.details.toLowerCase().includes(q)) ||
                    (l.ip_address && l.ip_address.includes(q))
                );
            },
            formatDate(isoString) {
                return new Date(isoString).toLocaleString('th-TH');
            }
        }));
    });
</script>
{% endblock %}
{% block content %}
<section x-data="logsPage()" x-init="load()">
    <div class="flex flex-col sm:flex-row items-center justify-between mb-6 gap-4">
        <div>
            <h1 class="text-2xl font-semibold">System Logs</h1>
            <p class="text-xs text-slate-500 mt-1">ประวัติการทำงานของผู้ดูแลระบบ</p>
        </div>
        <div class="flex items-center gap-3 w-full sm:w-auto">
            <div class="relative w-full sm:w-64">
                <input type="text" x-model="search" placeholder="ค้นหา Logs..."
                    class="w-full pl-9 pr-4 py-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-xs focus:ring-2 focus:ring-rose-500/20 outline-none transition">
                <svg xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
            <a href="/admin/dashboard"
                class="shrink-0 px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 text-xs transition">
                กลับแดชบอร์ด
            </a>
        </div>
    </div>

    <div
        class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr
                        class="bg-slate-50 dark:bg-slate-800 text-[11px] font-semibold text-slate-500 uppercase tracking-wider border-b border-slate-200 dark:border-slate-700">
                        <th class="px-4 py-3 whitespace-nowrap">Time</th>
                        <th class="px-4 py-3 whitespace-nowrap">Who</th>
                        <th class="px-4 py-3 whitespace-nowrap">Action</th>
                        <th class="px-4 py-3 w-full">Details</th>
                        <th class="px-4 py-3 whitespace-nowrap">IP Address</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 dark:divide-slate-800 text-xs">
                    <template x-for="log in filteredLogs" :key="log.id">
                        <tr class="hover:bg-slate-50/50 dark:hover:bg-slate-800/50 transition">
                            <td class="px-4 py-3 whitespace-nowrap font-mono text-slate-500"
                                x-text="formatDate(log.timestamp)"></td>
                            <td class="px-4 py-3 whitespace-nowrap font-medium text-slate-700 dark:text-slate-200">
                                <div class="flex items-center gap-2">
                                    <div class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-[10px] font-bold"
                                        x-text="log.admin_username.substring(0,2).toUpperCase()"></div>
                                    <span x-text="log.admin_username"></span>
                                </div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span
                                    class="px-2 py-1 rounded bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 font-mono text-[10px]"
                                    x-text="log.action"></span>
                            </td>
                            <td class="px-4 py-3 text-slate-600 dark:text-slate-400 break-all"
                                x-text="log.details || '-'"></td>
                            <td class="px-4 py-3 whitespace-nowrap font-mono text-slate-400"
                                x-text="log.ip_address || 'Unknown'"></td>
                        </tr>
                    </template>
                    <tr x-show="filteredLogs.length === 0">
                        <td colspan="5" class="px-6 py-12 text-center text-slate-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-3 text-slate-300"
                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            ไม่พบข้อมูล Logs
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</section>
{% endblock %}