{% extends "base.html" %}
{% block title %}จัดการกิจกรรม - DSNPRU_REG{% endblock %}
{% block head_extra %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('adminActivitiesPage', () => ({
            activities: [],
            groups: [],
            form: { title: '', description: '', max_people: 30, status: 'open', group_id: null },
            groupForm: { name: '', quota: 3 },
            showGroupManager: false,
            async load() {
                const token = localStorage.getItem('adminToken');
                if (!token) { window.location.href = '/admin/login'; return; }
                const [actRes, groupRes] = await Promise.all([
                    axios.get('/admin/api/activities', { headers: { Authorization: 'Bearer ' + token } }),
                    axios.get('/admin/api/activity_groups', { headers: { Authorization: 'Bearer ' + token } })
                ]);
                this.activities = actRes.data;
                this.groups = groupRes.data;
            },
            async createActivity() {
                const token = localStorage.getItem('adminToken');
                if (!token) { window.location.href = '/admin/login'; return; }
                try {
                    const res = await axios.post('/admin/create_activity', this.form, {
                        headers: { Authorization: 'Bearer ' + token }
                    });
                    this.activities.push(res.data);
                    this.form = { title: '', description: '', max_people: 30, status: 'open', group_id: null };
                    Toastify({ text: 'สร้างกิจกรรมสำเร็จ', backgroundColor: '#16a34a' }).showToast();
                } catch (e) {
                    Swal.fire('ผิดพลาด', 'ไม่สามารถสร้างกิจกรรมได้', 'error');
                }
            },
            async createGroup() {
                const token = localStorage.getItem('adminToken');
                try {
                    const res = await axios.post('/admin/api/activity_groups', this.groupForm, {
                        headers: { Authorization: 'Bearer ' + token }
                    });
                    this.groups.push(res.data);
                    this.groupForm.name = '';
                    Toastify({ text: 'สร้างกลุ่มสำเร็จ', backgroundColor: '#16a34a' }).showToast();
                } catch (e) {
                    Swal.fire('ผิดพลาด', 'ไม่สามารถสร้างกลุ่มได้', 'error');
                }
            },
            async removeGroup(groupId) {
                if (!confirm('ยืนยันการลบกลุ่ม? กิจกรรมในกลุ่มนี้จะไม่ถูกลบแต่จะไม่มีกลุ่ม')) return;
                const token = localStorage.getItem('adminToken');
                await axios.delete(`/admin/api/activity_groups/${groupId}`, {
                    headers: { Authorization: 'Bearer ' + token }
                });
                this.groups = this.groups.filter(g => g.id !== groupId);
                this.load(); // Refresh activities to clear group info
            },
            async toggle(activity) {
                const token = localStorage.getItem('adminToken');
                const res = await axios.post(`/admin/activities/${activity.id}/toggle`, {}, {
                    headers: { Authorization: 'Bearer ' + token }
                });
                const idx = this.activities.findIndex(a => a.id === activity.id);
                if (idx !== -1) this.activities[idx] = res.data;
            },
            async remove(activity) {
                const token = localStorage.getItem('adminToken');
                await axios.delete(`/admin/activities/${activity.id}`, {
                    headers: { Authorization: 'Bearer ' + token }
                });
                this.activities = this.activities.filter(a => a.id !== activity.id);
            }
        }));
    });
</script>
{% endblock %}
{% block content %}
<section x-data="adminActivitiesPage()" x-init="load()">
    <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-semibold">จัดการกิจกรรม</h1>
        <div class="flex gap-2">
            <button @click="showGroupManager = !showGroupManager"
                class="text-xs px-3 py-1 bg-rose-100 text-rose-700 rounded-full hover:bg-rose-200">
                <span x-text="showGroupManager ? 'ปิดจัดการกลุ่ม' : 'จัดการกลุ่มกิจกรรม'"></span>
            </button>
            <a href="/admin/dashboard" class="text-xs text-rose-600 hover:underline">กลับแดชบอร์ด</a>
        </div>
    </div>

    <!-- Group Manager -->
    <div x-show="showGroupManager" x-collapse class="mb-6 p-4 bg-rose-50 border border-rose-100 rounded-xl">
        <h2 class="text-sm font-semibold mb-3">จัดการกลุ่มกิจกรรม</h2>
        <div class="flex flex-col sm:flex-row gap-2 mb-4">
            <input type="text" x-model="groupForm.name" placeholder="ชื่อกลุ่มใหม่"
                class="flex-1 rounded-md border-rose-200 text-sm px-3 py-1.5 focus:ring-rose-500">
            <div class="flex items-center gap-2">
                <label class="text-[10px] text-rose-500 font-medium">โควตา:</label>
                <input type="number" x-model.number="groupForm.quota" min="1" max="10"
                    class="w-16 rounded-md border-rose-200 text-sm px-2 py-1.5 focus:ring-rose-500">
            </div>
            <button @click="createGroup"
                class="px-4 py-1.5 bg-rose-600 text-white rounded-md text-sm hover:bg-rose-700 whitespace-nowrap">
                เพิ่มกลุ่ม
            </button>
        </div>
        <div class="flex flex-wrap gap-2">
            <template x-for="group in groups" :key="group.id">
                <div class="flex items-center gap-2 px-3 py-1 bg-white border border-rose-200 rounded-full text-xs">
                    <span x-text="group.name" class="font-medium"></span>
                    <span class="text-[10px] text-rose-400" x-text="'(โควตา: ' + group.quota + ')'"></span>
                    <button @click="removeGroup(group.id)"
                        class="text-rose-400 hover:text-rose-600 ml-1">&times;</button>
                </div>
            </template>
        </div>
    </div>

    <div class="grid md:grid-cols-3 gap-6 mb-6">
        <div
            class="md:col-span-1 rounded-xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-4 space-y-3">
            <h2 class="text-sm font-semibold mb-1">สร้างกิจกรรมใหม่</h2>
            <div>
                <label class="block text-xs mb-1">ชื่อกิจกรรม</label>
                <input type="text" x-model="form.title"
                    class="w-full rounded-md border-slate-300 dark:border-slate-600 dark:bg-slate-800 text-sm px-3 py-1.5">
            </div>
            <div>
                <label class="block text-xs mb-1">กลุ่มกิจกรรม</label>
                <select x-model.number="form.group_id"
                    class="w-full rounded-md border-slate-300 dark:border-slate-600 dark:bg-slate-800 text-sm px-3 py-1.5">
                    <option :value="null">-- ไม่มีกลุ่ม --</option>
                    <template x-for="group in groups" :key="group.id">
                        <option :value="group.id" x-text="group.name"></option>
                    </template>
                </select>
            </div>
            <div>
                <label class="block text-xs mb-1">รายละเอียด</label>
                <textarea x-model="form.description"
                    class="w-full rounded-md border-slate-300 dark:border-slate-600 dark:bg-slate-800 text-sm px-3 py-1.5"></textarea>
            </div>
            <div class="flex gap-3">
                <div class="flex-1">
                    <label class="block text-xs mb-1">จำนวนรับสูงสุด</label>
                    <input type="number" x-model.number="form.max_people" min="1"
                        class="w-full rounded-md border-slate-300 dark:border-slate-600 dark:bg-slate-800 text-sm px-3 py-1.5">
                </div>
            </div>
            <button type="button" @click="createActivity"
                class="w-full mt-2 inline-flex justify-center items-center px-4 py-2 rounded-full bg-rose-600 hover:bg-rose-700 text-white text-sm font-medium">
                บันทึกกิจกรรม
            </button>
        </div>
        <div class="md:col-span-2">
            <div class="grid sm:grid-cols-2 gap-4">
                <template x-for="activity in activities" :key="activity.id">
                    <div
                        class="rounded-xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 p-4 flex flex-col gap-2">
                        <div class="flex items-start justify-between gap-2">
                            <div>
                                <div class="flex items-center gap-2">
                                    <div class="text-sm font-semibold" x-text="activity.title"></div>
                                    <span x-show="activity.group_name" x-text="activity.group_name"
                                        class="px-2 py-0.5 bg-rose-50 text-rose-600 border border-rose-100 rounded text-[10px]"></span>
                                </div>
                                <div class="text-xs text-slate-500 mt-1" x-text="activity.description"></div>
                            </div>
                            <span class="px-2 py-0.5 rounded-full text-[11px]"
                                :class="activity.status === 'open' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-200 text-slate-600'">
                                <span x-text="activity.status === 'open' ? 'เปิด' : 'ปิด'"></span>
                            </span>
                        </div>
                        <div class="text-xs text-slate-600 dark:text-slate-300">
                            ผู้สมัครแล้ว <span class="font-semibold" x-text="activity.registered_count"></span> /
                            <span x-text="activity.max_people"></span> (เหลือ
                            <span class="font-semibold" x-text="activity.remaining_seats"></span>)
                        </div>
                        <div class="flex gap-2 mt-1 text-xs">
                            <button class="px-3 py-1 rounded-full border border-slate-300 dark:border-slate-600"
                                @click="toggle(activity)">
                                เปิด/ปิดรับสมัคร
                            </button>
                            <button class="px-3 py-1 rounded-full border border-rose-300 text-rose-600"
                                @click="remove(activity)">
                                ลบ
                            </button>
                            <a class="ml-auto px-3 py-1 rounded-full bg-slate-900 text-white"
                                :href="`/admin/activity/${activity.id}`">
                                รายชื่อ
                            </a>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</section>
{% endblock %}